# Документация формата .krpg файлов

Формат .krpg - это специализированный язык разметки для создания сценариев в игре KRPG. Он позволяет определять игровые локации, персонажей, квесты, предметы и другие элементы игрового мира.

## Базовый синтаксис

### Комментарии
Комментарии начинаются с символа `#` и продолжаются до конца строки:
```krpg
# Это комментарий
map {
  # Это тоже комментарий
}
```

### Строки
Строки могут быть заключены в одинарные или двойные кавычки:
```krpg
location tavern "Таверна" "Уютное место для отдыха"
location market 'Рынок' 'Торговое место'
```

### Блоки и секции
Структура организована в блоки, заключенные в фигурные скобки `{}`:
```krpg
имя_секции аргумент1 аргумент2 {
  команда аргумент
  вложенная_секция {
    # содержимое
  }
}
```

### Команды
Команды - это строки с именем и аргументами:
```krpg
start main_street
link main_street market
give key 1
```

## Основные секции

### 1. Секция `map` - Игровой мир

Описывает локации, связи между ними и стартовую позицию.

```krpg
map {
  start main_street
  link main_street market
  link main_street village_edge
  
  location main_street "Центральная улица" "Главная улица деревни" {
    triggers {
      first_visit {
        print "Добро пожаловать в деревню!"
        unlock market
      }
    }
    action explore "Исследовать" {
      print "Вы осматриваете окрестности"
    }
  }
}
```

#### Команды секции map:
- `start <location_id>` - устанавливает стартовую локацию
- `link <location1> <location2>` - создает связь между локациями

#### Структура локации:
```krpg
location <id> <название> <описание> {
  triggers {
    first_visit { /* код при первом посещении */ }
    on_enter { /* код при входе */ }
    on_exit { /* код при выходе */ }
  }
  action <id> <название> {
    /* код действия */
  }
  item <id> <количество>
}
```

### 2. Секция `npcs` - Персонажи

Определяет неигровых персонажей, их состояния и доступные действия.

```krpg
npcs {
  npc trader "Торговец" "Продает товары" {
    init first_meet
    location market
    
    state first_meet {
      action meet "Познакомиться" {
        say "Добро пожаловать!"
        meet
        set_state base
      }
    }
    
    state base {
      action trade "Торговать" {
        trade {
          sell berry
          buy hp_bottle
        }
      }
    }
  }
}
```

#### Структура NPC:
```krpg
npc <id> <имя> <описание> {
  init <начальное_состояние>
  location <id_локации>
  
  state <имя_состояния> {
    action <id> <название> {
      /* команды действия */
    }
    action_req <id> <условие>  # действие доступно только при выполнении условия
  }
}
```

#### Команды в действиях NPC:
- `say "текст"` - персонаж говорит
- `ans "текст"` - ответ игрока
- `meet` - отметить знакомство с персонажем
- `set_state <состояние>` - изменить состояние персонажа
- `give <предмет> <количество>` - дать предмет игроку
- `require_item <предмет> [количество]` - забрать предмет у игрока
- `quest <id>` - выдать квест
- `unlock <location_id>` - открыть локацию

### 3. Секция `quests` - Квесты

Описывает игровые задания с этапами, целями и наградами.

```krpg
quests {
  quest delivery "Доставка" "Доставить посылки" {
    stage 0 "Найти получателей" {
      goal visit market "Посетить рынок"
      goal meet trader "Поговорить с торговцем"
      reward stage 1
    }
    
    stage 1 "Завершить доставку" {
      goal state trader delivered "Отчитаться торговцу"
      reward end
    }
  }
}
```

#### Структура квеста:
```krpg
quest <id> <название> <описание> {
  stage <номер> <название> {
    goal <тип> <аргументы> <описание>
    reward <тип> [аргументы]
  }
}
```

#### Типы целей (goal):
- `visit <location>` - посетить локацию
- `meet <npc>` - встретить персонажа
- `state <npc> <состояние>` - довести персонажа до определенного состояния
- `collect <предмет> <количество>` - собрать предметы
- `run <команда>` - выполнить команду

#### Типы наград (reward):
- `end` - завершить квест
- `stage <номер>` - перейти к следующему этапу
- `state <npc> <состояние>` - изменить состояние персонажа

### 4. Секция `items` - Предметы

Определяет игровые предметы и их свойства.

```krpg
items {
  item sword "Меч" "Острое оружие" {
    wear WEAPON 10 0 0 0 0 0 0  # тип_слота атрибуты_SPECIAW
    stack 1
    cost 50 100  # цена_продажи цена_покупки
  }
  
  item hp_bottle "Зелье здоровья" "Восстанавливает здоровье" {
    use hp 50
    stack 5
    cost 10 25
  }
  
  item key "Ключ" "Обычный ключ" {
    throwable true
  }
}
```

#### Свойства предметов:
- `wear <слот> <s> <p> <e> <c> <i> <a> <w>` - носимый предмет с атрибутами SPECIAW
- `use <тип> <количество>` - расходуемый предмет (hp для восстановления здоровья)
- `stack <размер>` - максимальный размер стака
- `cost <продажа> <покупка>` - цены предмета
- `throwable <true/false>` - можно ли выбросить предмет

#### Слоты для экипировки:
- `WEAPON` - оружие
- `ARMOR` - броня
- `HELMET` - шлем
- `GLOVES` - перчатки
- `BOOTS` - ботинки

### 5. Секция `entities` - Существа

Описывает монстров и других существ для боевой системы.

```krpg
entities {
  entity goblin "Гоблин" "Злобное существо" {
    speciaw 2 1 3 1 1 2 1  # атрибуты: Сила Восприятие Выносливость Харизма Интеллект Ловкость Мудрость
    money 15
  }
}
```

### 6. Секция `init` - Инициализация

Содержит код, выполняемый при начале игры.

```krpg
init {
  print "Добро пожаловать в игру!"
  print "Вы начинаете свое приключение..."
  pass 60  # пропустить 60 минут игрового времени
}
```

## Игровые команды в сценариях

### Вывод текста:
- `print "текст"` - вывести сообщение

### Управление временем:
- `pass <минуты>` - пропустить время

### Управление предметами:
- `give <предмет> [количество]` - дать предмет игроку
- `require_item <предмет> [количество]` - забрать предмет у игрока

### Управление локациями:
- `unlock <location>` - открыть доступ к локации

### Управление переменными:
- `set <имя> <значение>` - установить переменную
- `set <имя> "выражение"` - вычислить выражение и сохранить результат

### Условия:
- `if "условие" { ... }` - выполнить блок при выполнении условия

### Python выражения:
- `$ код` - выполнить произвольный Python код

## Примеры использования

### Простая локация с действием:
```krpg
map {
  location forest "Лес" "Темный лес" {
    action explore "Исследовать" {
      set _chance "game.random.randint(1, 100)"
      if "_chance > 50" {
        print "Вы нашли ягоды!"
        give berry 1
      }
      if "_chance <= 50" {
        print "Вы ничего не нашли"
      }
    }
  }
}
```

### NPC с условными действиями:
```krpg
npcs {
  npc guard "Стражник" "Охраняет вход" {
    init checking
    location gate
    
    state checking {
      action_req pass "game.player.has('pass')"
      action pass "Пройти" {
        say "Проходите"
        unlock castle
      }
      
      action talk "Поговорить" {
        if "not game.player.has('pass')" {
          say "Нужен пропуск для прохода"
        }
      }
    }
  }
}
```

### Квест со сбором предметов:
```krpg
quests {
  quest herb_gathering "Сбор трав" "Соберите лечебные травы" {
    stage 0 "Сбор" {
      goal collect healing_herb 5 "Соберите 5 лечебных трав"
      reward end
    }
  }
}
```

## Переменные и выражения

В сценариях можно использовать переменные и Python выражения:

- `game.player.name` - имя игрока
- `game.player.has('предмет')` - проверить наличие предмета
- `game.player.has('предмет', количество)` - проверить количество предмета
- `game.clock.days` - текущий день
- `game.clock.in_range(час_от, час_до)` - проверить время
- `game.random.randint(мин, макс)` - случайное число
- `game.quest_manager.is_done('квест')` - проверить завершенность квеста

Этот формат позволяет создавать богатые интерактивные сценарии для текстовой RPG игры с разветвленными диалогами, квестами и игровой механикой.